<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P2P Exchange — Easy Recharge MM</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1>P2P Exchange</h1>
      <div id="user-info" class="user-info"></div>
    </div>
  </header>

  <main class="container form-page">
    <section class="admin-box">
      <p>Admin Phone: <strong id="admin-phone" onclick="copyAdminPhone()">09xxxxxxxx</strong></p>
      <p class="muted">Instructions: Enter amount, choose from/to method. Fee is automatically calculated (2%).</p>
    </section>

    <form id="p2p-form" class="order-form">
      <label for="amount">Amount (Ks)</label>
      <input id="amount" name="amount" type="number" min="1" step="1" required>

      <label for="from">From</label>
      <select id="from" name="from" required>
        <option value="">— Select —</option>
        <option value="KBZ">KBZ</option>
        <option value="CB">CB</option>
        <option value="WaveMoney">WaveMoney</option>
      </select>

      <label for="to">To</label>
      <select id="to" name="to" required>
        <option value="">— Select —</option>
        <option value="WaveMoney">WaveMoney</option>
        <option value="KBZ">KBZ</option>
        <option value="CB">CB</option>
      </select>

      <div class="summary-line">
        <span>Fee (2%)</span>
        <strong id="fee">0</strong> <span>Ks</span>
      </div>

      <div class="summary-line">
        <span>Receive</span>
        <strong id="receive">0</strong> <span>Ks</span>
      </div>

      <label for="txP2p">Transaction ID</label>
      <input id="txP2p" name="txP2p" type="text" required />

      <button class="btn" type="submit">Submit P2P</button>
    </form>
  </main>

  <script type="module" src="price.js"></script>
  <script type="module" src="script.js"></script>
  <script>
    import { PRICES } from './price.js';
    const amt = document.getElementById('amount');
    const feeEl = document.getElementById('fee');
    const receiveEl = document.getElementById('receive');
    const frm = document.getElementById('p2p-form');

    function recalc() {
      const amount = Number(amt.value) || 0;
      const fee = Math.round(amount * (PRICES.p2p.feePercent ?? 0.02));
      feeEl.textContent = fee;
      receiveEl.textContent = Math.max(0, amount - fee);
    }

    amt.addEventListener('input', recalc);

    frm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (frm.from.value === frm.to.value) {
        alert('From and To cannot be the same.');
        return;
      }
      const payload = {
        type: 'p2p',
        amount: Number(frm.amount.value),
        from: frm.from.value,
        to: frm.to.value,
        txId: frm.txP2p.value,
        fee: Number(feeEl.textContent),
        receive: Number(receiveEl.textContent),
        userId: localStorage.getItem('userId') || null
      };
      await sendOrder(payload);
    });

    recalc();
  </script>
</body>
</html>
